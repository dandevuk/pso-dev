<?php	$deleteReq = '';		$errors = array('cd-order-delete'=>'','reason'=>'');		// Delete CD req on confirmation	if(isset($_POST['delete-cd-order-submit'])){				$deleteReq = $_POST['delete-req-confirm'];		$firstNameConfirm = $_POST['first-name-confirm'];		$lastNameConfirm = $_POST['last-name-confirm'];		$extConfirm = $_POST['ext-confirm'];		$positionConfirm = $_POST['position-confirm'];		$wardConfirm = $_POST['ward-confirm'];		$drugNameConfirm = $_POST['drug-name-confirm'];		$quantityConfirm = $_POST['quantity-confirm'];		$orderedOnConfirm = $_POST['ordered-on-confirm'];		$deletedBy = $_SESSION['first-name'] . ' ' . $_SESSION{'surname'};		$deleteReason = $_POST['reason-confirm'];		$deleteEmail = $_POST['email-confirm'];				$sql = "INSERT INTO cdReqNumberDeleted(reqNumberID, firstName, lastName, ext, position, ward, drugName, quantity, orderedOn, deletedBy, deletedReason) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)";		$params = array($deleteReq, $firstNameConfirm, $lastNameConfirm, $extConfirm, $positionConfirm, $wardConfirm, $drugNameConfirm, $quantityConfirm, $orderedOnConfirm, $deletedBy, $deleteReason);		$stmt = sqlsrv_query($conn,$sql,$params);				// CHECK TO SEE IF ROW HAS BEEN SUCCESSFULLY ENTER INTO cdreqnumberdeleted, IF SO THEN DELETE FROM cdreqnumberprocessed				if(!$stmt){				echo 'insert error: ' . sqlsrv_errors($conn);				if($stmt === false ) {					if( ($errors = sqlsrv_errors() ) != null) {						foreach( $errors as $error ) {							echo "SQLSTATE: ".$error[ 'SQLSTATE']."<br />";							echo "code: ".$error[ 'code']."<br />";							echo "message: ".$error[ 'message']."<br />";						}					}				}			}	else {								$deleteCDOrderTable = "DELETE FROM cdreqnumberprocessed WHERE reqNumberID = '$deleteReq'";				$reqDeleted = '<b>' . $deleteReq . '</b>&nbsp;has been deleted.';								include('config/cd-order-delete-mailer.php'); 									if (!sqlsrv_query($conn, $deleteCDOrderTable)){					echo 'delete error: ' . sqlsrv_errors($conn);				}				}			}		$dateToday = date("Y/m/d");				$sqlDate = "SELECT * FROM cdreqnumberprocessed WHERE CAST(processedOn AS DATE) = '$dateToday'  ORDER BY processedOn";	$resultDate = sqlsrv_query($conn, $sqlDate);	$resultRowsDate = sqlsrv_has_rows($resultDate);				if( $resultDate === false) {						die( print_r( sqlsrv_errors(), true) );					}		if (isset($_POST['date-submit'])) {			$dateSearch = $_POST['dateSearch'];						$sqlDateSearch = "SELECT * FROM cdreqnumberprocessed WHERE CAST(processedOn AS DATE) = '$dateSearch'  ORDER BY processedOn";		$resultDateSearch = sqlsrv_query($conn, $sqlDateSearch);		$resultRowsDateSearch = sqlsrv_has_rows($resultDateSearch);						if( $resultDateSearch === false) {								die( print_r( sqlsrv_errors(), true) );							}			}?><?phpif (isset($_SESSION['user-role'])) {		if (($_SESSION['user-role'] == 'Admin') || ($_SESSION['user-role'] == 'Pharmacy manager') || ($_SESSION['user-role'] == 'Dispensary user')){		if (isset($deleteCDOrderTable)) {			echo '<div class="success-ward-wrapper">';			echo '<div class="success-ward-container">';			echo $reqDeleted; 			echo '</div>';			echo '</div>';		} ?>				<div class="list-table-wrapper">		<h1>Dispensed CD Orders</h1>			<div class="audit-search-container">			<div class="search-select">									Please select a date<br /><br />										<form method="post" action="">												<input type="date" name="dateSearch">					<br /><br />					<button type="submit" name="date-submit">Search</button>											</form>									</div>		</div>		<?php  if (isset($dateSearch)) {						if ($resultRowsDateSearch === false) { ?>						<div class="no-orders">						No CD orders dispensed on this day				</div>				<?php } else { ?>								<table>											<tr>							<th>Req No.</th>							<th>Name</th>							<th>Ward</th>							<th>Drug</th>							<th>Quantity</th>							<th>Ordered</th>							<th>Processed</th>														<th>Delete</th>						</tr>										<?php while ($row = sqlsrv_fetch_array($resultDateSearch, SQLSRV_FETCH_ASSOC)) { ?>											<tr>											<td><?php echo $row['reqNumberID'] ?></td>							<td><?php echo $row['firstName'] ?> <?php echo $row['lastName'] ?></td>							<td><?php echo $row['ward'] ?></td>							<td><?php echo $row['drugName'] ?></td>							<td><?php echo $row['quantity'] ?></td>							<td><?php echo $row['orderedOn']; ?></td>							<td><?php echo $row['processedOn']->format('d-M-Y'); ?></td>															<td><button class="cd-btn-delete" onclick="document.getElementById('row<?php echo $row['reqNumberID']; ?>').style.display='block'"><!--<i class="fas fa-times-circle" style="color:red"></i>-->X</button></td>										</tr>						<!-- When action button pressed this will display -->						<div class="delete-cd-wrapper" id="row<?php echo $row['reqNumberID']; ?>">							<div class="delete-cd-close">								<i class="fas fa-times" onclick="document.getElementById('row<?php echo $row['reqNumberID']; ?>').style.display='none'"></i>							</div>							<form method="POST" action="">								<div class="cd-delete-modal">																		<div class="cd-delete-modal-left">										Requisition number:<br>										<?php echo $row['reqNumberID'] ?>										<input type="hidden" name="delete-req-confirm" value="<?php echo $row['reqNumberID'] ?>"><br><br>										Ordered by:<br>										<?php echo $row['firstName'] ?> <?php echo $row['lastName'] ?>										<input type="hidden" name="first-name-confirm" value="<?php echo $row['firstName'] ?>">										<input type="hidden" name="last-name-confirm" value="<?php echo $row['lastName'] ?>"><br><br>										Ward:<br>										<?php echo $row['ward'] ?>										<input type="hidden" name="ward-confirm" value="<?php echo $row['ward'] ?>"><br><br>										Drug:<br>										<?php echo $row['drugName'] ?>										<input type="hidden" name="drug-name-confirm" value="<?php echo $row['drugName'] ?>"><br><br>										Quantity:<br>										<?php echo $row['quantity'] ?>										<input type="hidden" name="quantity-confirm" value="<?php echo $row['quantity'] ?>"><br><br>										Date ordered:<br>										<?php echo $row['processedOn']->format('d-M-Y'); ?>										<input type="hidden" name="ordered-on-confirm" value="<?php echo $row['processedOn']->format('d-M-Y'); ?>">																					<input type="hidden" name="ext-confirm" value="<?php echo $row['ext'] ?>">																					<input type="hidden" name="position-confirm" value="<?php echo $row['position'] ?>">																					<input type="hidden" name="email-confirm" value="<?php echo $row['email'] ?>">																			</div>																		<div>										Reason for deletion<br />										<select name="reason-confirm">											<option disabled selected value> -- Select an option -- </option>											<option>Duplicated</option>											<option>Restricted use</option>											<option>Unavailable</option>										</select>										<div class="error-message"><?php echo $errors['reason'] ?></div>											<br /><br />											<button type="submit" name="delete-cd-order-submit"><i class="fas fa-minus-circle"></i> DELETE</button>										</div>																		</div>								</form>							</div>																				<?php } ?>															</table>				<?php } 					} else {			if ($resultRowsDate === false) { ?>								<div class="no-orders">					No CD orders dispensed today				</div>			<?php } else { ?>					<table>									<tr>						<th>Req No.</th>						<th>Name</th>						<th>Ward</th>						<th>Drug</th>						<th>Quantity</th>						<th>Ordered</th>						<th>Processed</th>												<th>Delete</th>					</tr>								<?php while ($row = sqlsrv_fetch_array($resultDate, SQLSRV_FETCH_ASSOC)) { ?>												<tr>												<td><?php echo $row['reqNumberID'] ?></td>								<td><?php echo $row['firstName'] ?> <?php echo $row['lastName'] ?></td>								<td><?php echo $row['ward'] ?></td>								<td><?php echo $row['drugName'] ?></td>								<td><?php echo $row['quantity'] ?></td>								<td><?php echo $row['orderedOn']; ?></td>								<td><?php echo $row['processedOn']->format('d-M-Y'); ?></td>																<td><button class="cd-btn-delete" onclick="document.getElementById('row<?php echo $row['reqNumberID']; ?>').style.display='block'"><!--<i class="fas fa-times-circle" style="color:red"></i>-->X</button></td>											</tr>							<!-- When action button pressed this will display -->							<div class="delete-cd-wrapper" id="row<?php echo $row['reqNumberID']; ?>">								<div class="delete-cd-close">									<i class="fas fa-times" onclick="document.getElementById('row<?php echo $row['reqNumberID']; ?>').style.display='none'"></i>								</div>								<form method="POST" action="">									<div class="cd-delete-modal">																			<div class="cd-delete-modal-left">											Requisition number:<br>											<?php echo $row['reqNumberID'] ?>											<input type="hidden" name="delete-req-confirm" value="<?php echo $row['reqNumberID'] ?>"><br><br>											Ordered by:<br>											<?php echo $row['firstName'] ?> <?php echo $row['lastName'] ?>											<input type="hidden" name="first-name-confirm" value="<?php echo $row['firstName'] ?>">											<input type="hidden" name="last-name-confirm" value="<?php echo $row['lastName'] ?>"><br><br>											Ward:<br>											<?php echo $row['ward'] ?>											<input type="hidden" name="ward-confirm" value="<?php echo $row['ward'] ?>"><br><br>											Drug:<br>											<?php echo $row['drugName'] ?>											<input type="hidden" name="drug-name-confirm" value="<?php echo $row['drugName'] ?>"><br><br>											Quantity:<br>											<?php echo $row['quantity'] ?>											<input type="hidden" name="quantity-confirm" value="<?php echo $row['quantity'] ?>"><br><br>											Date ordered:<br>											<?php echo $row['processedOn']->format('d-M-Y'); ?>											<input type="hidden" name="ordered-on-confirm" value="<?php echo $row['processedOn']->format('d-M-Y'); ?>">																						<input type="hidden" name="ext-confirm" value="<?php echo $row['ext'] ?>">																						<input type="hidden" name="position-confirm" value="<?php echo $row['position'] ?>">																					<input type="hidden" name="email-confirm" value="<?php echo $row['email'] ?>">																				</div>																			<div>											Reason for deletion<br />											<select name="reason-confirm">												<option disabled selected value> -- Select an option -- </option>												<option>Duplicated</option>												<option>Restricted use</option>												<option>Unavailable</option>											</select>											<div class="error-message"><?php echo $errors['reason'] ?></div>											<br /><br />																						<button type="submit" name="delete-cd-order-submit"><i class="fas fa-minus-circle"></i> DELETE</button>										</div>																		</div>															</form>							</div>																				<?php } ?>																</table></div>			<?php } ?><div class="process-orders-container">	<form target="_blank" method="POST" action="config/process-cd-orders.php" >		<button type="submit" name="process-cd-orders-submit">Process orders</button>	</form>	<a href="processed-cd-orders.php"><button style="margin-top:10px">View processed orders</button></a></div>	<?php  } 				    } else {				echo '<script>window.location.href = "index.php";</script>';		}}?>
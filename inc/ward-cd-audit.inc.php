<?php 	$rowCountReq = '';	$errors = array('reqSearch'=>'','drugSearch'=>'','wardSearch'=>'','dateSearch'=>'','drugDeletedBy'=>'','name'=>'','no-ward'=>'');		if (!empty($_SESSION['ward'])) {				$wardSelect = $_SESSION['ward'];			} 		if (isset($_POST['change-ward'])) {		unset($_SESSION['ward']);	}		//Select ward to audit	    if(isset($_POST['cd-ward-audit-submit'])) {				if(empty($_POST['cd-ward-audit'])){			$errors['no-ward'] = 'Please select a ward';		} else{			$wardSelect = $_POST['cd-ward-audit'];			$_SESSION['ward'] = $wardSelect;		}	}	if (isset($_POST['reqNumSubmit'])) {		if (empty($_POST['reqNumSearch'])) {			$errors['reqSearch'] = 'Input field empty, please enter a requisition number';		} else {			$reqNumSearch = htmlspecialchars($_POST['reqNumSearch']);						$sql = "SELECT * FROM cdreqnumberprocessed WHERE (ward = '$wardSelect' AND reqNumberID='$reqNumSearch') ORDER BY orderedOn DESC";			$stmtReq = sqlsrv_query($conn, $sql);			$rowCountReq = sqlsrv_has_rows($stmtReq);						$sqlD = "SELECT * FROM cdreqnumberdeleted WHERE (ward = '$wardSelect' AND reqNumberID='$reqNumSearch') ORDER BY orderedOn DESC";			$stmtReqD = sqlsrv_query($conn, $sqlD);			$rowCountReqD = sqlsrv_has_rows($stmtReqD);		}	}	if (isset($_POST['nameSubmit'])) {		if (empty($_POST['nameSearch'])) {			$errors['name'] = 'Input field empty, please select a name';		} else {			$nameSearch = htmlspecialchars($_POST['nameSearch']);						$sql = "SELECT * FROM cdreqnumberprocessed WHERE (ward = '$wardSelect' AND lastName='$nameSearch') ORDER BY orderedOn DESC";			$stmtName = sqlsrv_query($conn, $sql);			$rowCountName = sqlsrv_has_rows($stmtName);						$sqlD = "SELECT * FROM cdreqnumberdeleted WHERE (ward = '$wardSelect' AND lastName='$nameSearch') ORDER BY orderedOn DESC";			$stmtNameD = sqlsrv_query($conn, $sqlD);			$rowCountNameD = sqlsrv_has_rows($stmtNameD);		}	}	if (isset($_POST['drugSubmit'])) {		if (empty($_POST['drugSearch'])) {			$errors['drugSearch'] = 'Please select a drug.';		} else {			$drugSearch = $_POST['drugSearch'];						$sql = "SELECT * FROM cdreqnumberprocessed WHERE (ward = '$wardSelect' AND drugName='$drugSearch') ORDER BY orderedOn DESC";			$stmtDrug = sqlsrv_query($conn, $sql);			$rowCountDrug = sqlsrv_has_rows($stmtDrug);						$sqlD = "SELECT * FROM cdreqnumberdeleted WHERE (ward = '$wardSelect' AND drugName='$drugSearch') ORDER BY orderedOn DESC";			$stmtDrugD = sqlsrv_query($conn, $sqlD);			$rowCountDrugD = sqlsrv_has_rows($stmtDrugD);		}	}	if (isset($_POST['dateSubmit'])) {		if (empty($_POST['dateSearch'])) {			$errors['dateSearch'] = 'Please select a date.';		} else {			$dateSearch = $_POST['dateSearch'];						$sql = "SELECT * FROM cdreqnumberprocessed WHERE (ward = '$wardSelect' AND CAST(orderedOn AS DATE) = '$dateSearch') ORDER BY orderedOn DESC";			$stmtDate = sqlsrv_query($conn, $sql);			$rowCountDate = sqlsrv_has_rows($stmtDate);						$sqlD = "SELECT * FROM cdreqnumberdeleted WHERE (ward = '$wardSelect' AND CAST(orderedOn AS DATE) = '$dateSearch') ORDER BY orderedOn DESC";			$stmtDateD = sqlsrv_query($conn, $sqlD);			$rowCountDateD = sqlsrv_has_rows($stmtDateD);		}	}?><?phpif ($_SESSION['user-role'] == 'Admin' || $_SESSION['user-role'] == 'Ward/dept manager') { if (!isset($_SESSION['ward'])) { ?>	<?php include 'config/fetch-ward-list.php'; ?>	<div class="select-ward-audit-container">	<h3>CD Ward Audit</h3>	<form method="POST" action="">		Select ward: 		<select style="max-width: 50%" name="cd-ward-audit">			<option disabled selected value> -- Select an option -- </option>				<?php while( $row = sqlsrv_fetch_array( $stmt) ) { ?>					<option><?php echo $row[0] ?></option>				<?php }; ?>		</select>			    <br /><br />		<button type="submit" name="cd-ward-audit-submit"><i class="fas fa-hospital"></i> SELECT</button>	</form>	<div class="error-message"><?php echo $errors['no-ward'];?></div></div><?php } else { ?><div class="list-table-wrapper">			<h1><?php echo $wardSelect ?> Controlled Drug Requisition Audit</h1>		<div class="audit-tab-container">				<ul>								<li class="search-btn search-btn-selected tablink" onclick="openSearch(event,'reqNum')">Requsition number</li>				<li class="search-btn tablink" onclick="openSearch(event,'name')">Ordered by</li>				<li class="search-btn tablink" onclick="openSearch(event,'drug')">Drug</li>				<li class="search-btn tablink" onclick="openSearch(event,'date')">Date ordered</li>						</ul>				</div>				<div class="audit-search-container">					<div class="search-select" id="reqNum">							Please enter CD requisition number<br /><br />								<form method="post" action="">									<input type="text" name="reqNumSearch"><span> <?php echo $errors['reqSearch'] ?></span>					<br /><br />					<button type="submit" name="reqNumSubmit">Search</button>					<button type="submit" name="change-ward">Change ward</button>								</form>						</div>				<div class="search-select" style="display:none;" id="name">							Please select a surname<br /><br />								<form method="POST" action="">											<select name="nameSearch">											<option disabled selected value> -- Select last name -- </option>										<?php							$sqlFetchName = "SELECT lastName FROM cdreqnumberprocessed WHERE ward = '$wardSelect' UNION SELECT lastName FROM cdreqnumberdeleted WHERE ward = '$wardSelect' ORDER BY lastName";							$stmtFetchName = sqlsrv_query($conn, $sqlFetchName);							while ($row = sqlsrv_fetch_array($stmtFetchName)) { ?>															<option value="<?php echo $row[0]; ?>"><?php echo $row[0]; ?></option>												<?php } ?>												</select><span> <?php echo $errors['name'] ?></span>					<br /><br />					<button type="submit" name="nameSubmit">Search</button>					<button type="submit" name="change-ward">Change ward</button>										</form>						</div>					<div class="search-select" style="display:none;" id="drug">							Please select drug<br /><br />								<form method="POST" action="">											<select name="drugSearch">											<option disabled selected value> -- Select drug -- </option>										<?php											$sqlFetchDrugs = "SELECT drugName FROM cdreqnumberprocessed WHERE ward = '$wardSelect' UNION SELECT drugName FROM cdreqnumberdeleted WHERE ward = '$wardSelect' ORDER BY drugName";							$stmtFetchDrugs = sqlsrv_query($conn, $sqlFetchDrugs);							while ($row = sqlsrv_fetch_array($stmtFetchDrugs)) { ?>															<option value="<?php echo $row[0]; ?>"><?php echo $row[0]; ?></option>												<?php } ?>												</select><span> <?php echo $errors['drugSearch'] ?></span>					<br /><br />					<button type="submit" name="drugSubmit">Search</button>					<button type="submit" name="change-ward">Change ward</button>										</form>						</div>					<div class="search-select" style="display:none;" id="date">							Please select a date<br /><br />								<form method="post" action="">									<input type="date" name="dateSearch"><span> <?php echo $errors['dateSearch'] ?></span>					<br /><br />					<button type="submit" name="dateSubmit">Search</button>					<button type="submit" name="change-ward">Change ward</button>								</form>						</div>				</div>


		<table>

    					 	<table>

    					 	<?php 			if (isset($reqNumSearch)) {			    			if ($rowCountReq === true) {				echo "<tr>			    	<th>Req No.</th>			    	<th>Name</th>			    	<th>Ward</th>			    	<th>Drug</th>			    	<th>Quantity</th>			    	<th>Ordered</th>	    		</tr>";    			while ($row = sqlsrv_fetch_array($stmtReq, SQLSRV_FETCH_ASSOC)) { ?>    			<tr>    				<td><?php echo $row['reqNumberID'] ?></td>    				<td><?php echo $row['firstName'] ?> <?php echo $row['lastName'] ?></td>    				<td><?php echo $row['ward'] ?></td>    				<td><?php echo $row['drugName'] ?></td>    				<td><?php echo $row['quantity'] ?></td>    				<td><?php echo $row['orderedOn'] ?></td>    			</tr>								<?php } } else {							echo "<div class='no-orders'>";							echo "Order requisition number has not been processed for this ward.";							echo "</div>";						}		} else if (isset($nameSearch)) {			    			if ($rowCountName === true) {				echo "<tr>			    	<th>Req No.</th>			    	<th>Name</th>			    	<th>Ward</th>			    	<th>Drug</th>			    	<th>Quantity</th>			    	<th>Ordered</th>	    		</tr>";    			while ($row = sqlsrv_fetch_array($stmtName, SQLSRV_FETCH_ASSOC)) { ?>    			<tr>    				<td><?php echo $row['reqNumberID'] ?></td>    				<td><?php echo $row['firstName'] ?> <?php echo $row['lastName'] ?></td>    				<td><?php echo $row['ward'] ?></td>    				<td><?php echo $row['drugName'] ?></td>    				<td><?php echo $row['quantity'] ?></td>    				<td><?php echo $row['orderedOn']; ?></td>    			</tr>								<?php } } else {							echo "<div class='no-orders'>";							echo "This person has not had a CD order processed for this ward.";							echo "</div>";						}  		} else if (isset($drugSearch)) {			    			if ($rowCountDrug === true) {				echo "<tr>			    	<th>Req No.</th>			    	<th>Name</th>			    	<th>Ward</th>			    	<th>Drug</th>			    	<th>Quantity</th>			    	<th>Ordered</th>	    		</tr>";    			while ($row = sqlsrv_fetch_array($stmtDrug, SQLSRV_FETCH_ASSOC)) { ?>    			<tr>    				<td><?php echo $row['reqNumberID'] ?></td>    				<td><?php echo $row['firstName'] ?> <?php echo $row['lastName'] ?></td>    				<td><?php echo $row['ward'] ?></td>    				<td><?php echo $row['drugName'] ?></td>    				<td><?php echo $row['quantity'] ?></td>    				<td><?php echo $row['orderedOn']; ?></td>    			</tr>    		<?php } } else {							echo "<div class='no-orders'>";							echo "This drug has not been ordered and supplied for this ward.";							echo "</div>";						} } else if (isset($wardSearch)) {			    			if ($rowCountWard === true) {				echo "<tr>			    	<th>Req No.</th>			    	<th>Name</th>			    	<th>Ward</th>			    	<th>Drug</th>			    	<th>Quantity</th>			    	<th>Ordered</th>	    		</tr>";    			while ($row = sqlsrv_fetch_array($stmtWard, SQLSRV_FETCH_ASSOC)) { ?>    			<tr>    				<td><?php echo $row['reqNumberID'] ?></td>    				<td><?php echo $row['firstName'] ?> <?php echo $row['lastName'] ?></td>    				<td><?php echo $row['ward'] ?></td>    				<td><?php echo $row['drugName'] ?></td>    				<td><?php echo $row['quantity'] ?></td>    				<td><?php echo $row['orderedOn']; ?></td>    			</tr> 								<?php } } } else if (isset($dateSearch)) {			    			if ($rowCountDate === true) {				echo "<tr>			    	<th>Req No.</th>			    	<th>Name</th>			    	<th>Ward</th>			    	<th>Drug</th>			    	<th>Quantity</th>			    	<th>Ordered</th>	    		</tr>";    			while ($row = sqlsrv_fetch_array($stmtDate, SQLSRV_FETCH_ASSOC)) { ?>    			<tr>    				<td><?php echo $row['reqNumberID'] ?></td>    				<td><?php echo $row['firstName'] ?> <?php echo $row['lastName'] ?></td>    				<td><?php echo $row['ward'] ?></td>    				<td><?php echo $row['drugName'] ?></td>    				<td><?php echo $row['quantity'] ?></td>    				<td><?php echo $row['orderedOn']; ?></td>    			</tr> 								<?php } } else {							echo "<div class='no-orders'>";							echo "No CD requisitions ordered and supplied on this date.";							echo "</div>";				} } else {										if (!isset($_POST['reqNumSubmit'])) {							echo "<div class='select-ward'>";							echo "Please search a field to view deleted controlled drug requisitions";							echo "</div>";						} } ?>
		</table>				<table>				<?php 			if (isset($reqNumSearch)) {			    			if ($rowCountReqD === true) {									echo "<tr><th colspan='9' style='background-color:#333'>Deleted CD Orders</th></tr>";				echo "<tr>			    	<th>Req No.</th>			    	<th>Name</th>			    	<th>Ward</th>			    	<th>Drug</th>			    	<th>Quantity</th>			    	<th>Ordered</th>			    	<th style='background-color: #078883;border-left:8px solid #fff'>Deleted by</th>			    	<th style='background-color: #078883'>Reason</th>			    	<th style='background-color: #078883'>Date deleted</th>	    		</tr>";    			while ($row = sqlsrv_fetch_array($stmtReqD, SQLSRV_FETCH_ASSOC)) { ?>    			<tr>    				<td><?php echo $row['reqNumberID'] ?></td>    				<td><?php echo $row['firstName'] ?> <?php echo $row['lastName'] ?></td>    				<td><?php echo $row['ward'] ?></td>    				<td><?php echo $row['drugName'] ?></td>    				<td><?php echo $row['quantity'] ?></td>    				<td><?php echo $row['orderedOn'] ?></td>    				<td style="border-left:8px solid #fff"><?php echo $row['deletedBy'] ?></td>    				<td><?php echo $row['deletedReason'] ?></td>    				<td><?php echo $row['deletedOn']->format('d-M-Y'); ?></td>    			</tr>								<?php } } else {							echo "<div class='no-orders'>";							echo "This requisition number has not been deleted for this ward.";							echo "</div>";						}		} else if (isset($nameSearch)) {			    			if ($rowCountNameD === true) {									echo "<tr><th colspan='9' style='background-color:#333'>Deleted CD Orders</th></tr>";				echo "<tr>			    	<th>Req No.</th>			    	<th>Name</th>			    	<th>Ward</th>			    	<th>Drug</th>			    	<th>Quantity</th>			    	<th>Ordered</th>			    	<th style='background-color: #078883;border-left:8px solid #fff'>Deleted by</th>			    	<th style='background-color: #078883'>Reason</th>			    	<th style='background-color: #078883'>Date deleted</th>	    		</tr>";    			while ($row = sqlsrv_fetch_array($stmtNameD, SQLSRV_FETCH_ASSOC)) { ?>    			<tr>    				<td><?php echo $row['reqNumberID'] ?></td>    				<td><?php echo $row['firstName'] ?> <?php echo $row['lastName'] ?></td>    				<td><?php echo $row['ward'] ?></td>    				<td><?php echo $row['drugName'] ?></td>    				<td><?php echo $row['quantity'] ?></td>    				<td><?php echo $row['orderedOn'] ?></td>    				<td style="border-left:8px solid #fff"><?php echo $row['deletedBy'] ?></td>    				<td><?php echo $row['deletedReason'] ?></td>    				<td><?php echo $row['deletedOn']->format('d-M-Y'); ?></td>    			</tr>								<?php } } else {							echo "<div class='no-orders'>";							echo "There are no orders that have been deleted for this person.";							echo "</div>";						}  		} else if (isset($drugSearch)) {			    			if ($rowCountDrugD === true) {									echo "<tr><th colspan='9' style='background-color:#333'>Deleted CD Orders</th></tr>";				echo "<tr>			    	<th>Req No.</th>			    	<th>Name</th>			    	<th>Ward</th>			    	<th>Drug</th>			    	<th>Quantity</th>			    	<th>Ordered</th>			    	<th style='background-color: #078883;border-left:8px solid #fff'>Deleted by</th>			    	<th style='background-color: #078883'>Reason</th>			    	<th style='background-color: #078883'>Date deleted</th>	    		</tr>";    			while ($row = sqlsrv_fetch_array($stmtDrugD, SQLSRV_FETCH_ASSOC)) { ?>    			<tr>    				<td><?php echo $row['reqNumberID'] ?></td>    				<td><?php echo $row['firstName'] ?> <?php echo $row['lastName'] ?></td>    				<td><?php echo $row['ward'] ?></td>    				<td><?php echo $row['drugName'] ?></td>    				<td><?php echo $row['quantity'] ?></td>    				<td><?php echo $row['orderedOn'] ?></td>    				<td style="border-left:8px solid #fff"><?php echo $row['deletedBy'] ?></td>    				<td><?php echo $row['deletedReason'] ?></td>    				<td><?php echo $row['deletedOn']->format('d-M-Y'); ?></td>    			</tr>    		<?php } } else {							echo "<div class='no-orders'>";							echo "There are no orders that have been deleted for this drug.";							echo "</div>";						} } else if (isset($wardSearch)) {			    			if ($rowCountWardD === true) {									echo "<tr><th colspan='9' style='background-color:#333'>Deleted CD Orders</th></tr>";				echo "<tr>			    	<th>Req No.</th>			    	<th>Name</th>			    	<th>Ward</th>			    	<th>Drug</th>			    	<th>Quantity</th>			    	<th>Ordered</th>			    	<th style='background-color: #078883;border-left:8px solid #fff'>Deleted by</th>			    	<th style='background-color: #078883'>Reason</th>			    	<th style='background-color: #078883'>Date deleted</th>	    		</tr>";    			while ($row = sqlsrv_fetch_array($stmtWardD, SQLSRV_FETCH_ASSOC)) { ?>    			<tr>    				<td><?php echo $row['reqNumberID'] ?></td>    				<td><?php echo $row['firstName'] ?> <?php echo $row['lastName'] ?></td>    				<td><?php echo $row['ward'] ?></td>    				<td><?php echo $row['drugName'] ?></td>    				<td><?php echo $row['quantity'] ?></td>    				<td><?php echo $row['orderedOn'] ?></td>    				<td style="border-left:8px solid #fff"><?php echo $row['deletedBy'] ?></td>    				<td><?php echo $row['deletedReason'] ?></td>    				<td><?php echo $row['deletedOn']->format('d-M-Y'); ?></td>    			</tr> 								<?php } } } else if (isset($dateSearch)) {			    			if ($rowCountDateD === true) {									echo "<tr><th colspan='9' style='background-color:#333'>Deleted CD Orders</th></tr>";				echo "<tr>			    	<th>Req No.</th>			    	<th>Name</th>			    	<th>Ward</th>			    	<th>Drug</th>			    	<th>Quantity</th>			    	<th>Ordered</th>			    	<th style='background-color: #078883;border-left:8px solid #fff'>Deleted by</th>			    	<th style='background-color: #078883'>Reason</th>			    	<th style='background-color: #078883'>Date deleted</th>	    		</tr>";    			while ($row = sqlsrv_fetch_array($stmtDateD, SQLSRV_FETCH_ASSOC)) { ?>    			<tr>    				<td><?php echo $row['reqNumberID'] ?></td>    				<td><?php echo $row['firstName'] ?> <?php echo $row['lastName'] ?></td>    				<td><?php echo $row['ward'] ?></td>    				<td><?php echo $row['drugName'] ?></td>    				<td><?php echo $row['quantity'] ?></td>    				<td><?php echo $row['orderedOn'] ?></td>    				<td style="border-left:8px solid #fff"><?php echo $row['deletedBy'] ?></td>    				<td><?php echo $row['deletedReason'] ?></td>    				<td><?php echo $row['deletedOn']->format('d-M-Y'); ?></td>    			</tr> 								<?php } } else {							echo "<div class='no-orders'>";							echo "There are no orders that have been deleted on this date.";							echo "</div>";				} } ?>		</table></div><?php } } else {	echo '<script>window.location.href = "index.php";</script>';} ?><script>function openSearch(evt, searchName) {  var i, x, tablinks;  x = document.getElementsByClassName("search-select");  for (i = 0; i < x.length; i++) {    x[i].style.display = "none";  }  tablinks = document.getElementsByClassName("tablink");  for (i = 0; i < x.length; i++) {    tablinks[i].className = tablinks[i].className.replace(" search-btn-selected", "");  }  document.getElementById(searchName).style.display = "block";  evt.currentTarget.className += " search-btn-selected";}</script>